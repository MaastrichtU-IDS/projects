name: Deploy website to GitHub Pages
on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - uses: actions/setup-node@v1
      with:
        node-version: 12

    - name: Install dependencies and build
      run: |
        git config --global user.email "vincent.emonet@maastrichtuniversity.nl"
        git config --global user.name "Vincent Emonet"
        yarn install
        yarn build

    - name: Deploy on GitHub
      uses: JamesIves/github-pages-deploy-action@3.7.1
      with:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        BRANCH: gh-pages
        FOLDER: web-build
        CLEAN: true

    # - name: Deploy on GitHub
    #   run: yarn deploy

    - name: Convert JSON-LD schema:Dataset to HTML pages
      # env:
      #   GIT_SERVICE: ${{ matrix.git-service }}
        # RUN_LABEL: ${{ matrix.search-string }}
      run: |
        rm -rf node_modules
        rm -rf web-build
        git fetch
        git checkout gh-pages
        # sudo apt update
        # sudo apt install wget
        pip install 'pandas==1.2.2'
        wget https://raw.githubusercontent.com/kodymoodley/fair-metadata-html-page-generator/main/jsonld_to_html.py
        
        echo "[\n" > datasets_list.json
        # Generate html for each .jsonld in datasets/*
        find ./datasets/ -name '*.jsonld' | while read NAME ; do 
          FOLDER=$(echo "${NAME}" | sed -r 's/\.\/([^\/]*)\/([^\/]*)\/(.*)$/\2/')
          FILENAME=$(echo "${NAME}" | sed -r 's/\.\/([^\/]*)\/([^\/]*)\/(.*)$/\3/')
          mkdir -p $FOLDER
          python jsonld_to_html.py datasets/$FOLDER/$FILENAME $FOLDER/index.html
          cat datasets/$FOLDER/$FILENAME >> datasets_list.json
          echo ",\n" >> datasets_list.json
        done
        echo "\n]" >> datasets_list.json

        rm -rf datasets
        rm -f jsonld_to_html.py
        git config --global user.email "vincent.emonet@gmail.com"
        git config --global user.name "Vincent Emonet"
        git add *
        git commit -m "Update schema:Dataset HTML pages" || exit 0
        git push || exit 0
      # Concatenate files in the queries folder to assets/datasets_list.json
      # sed -s '$a,' queries/*.rq | head -n -1 > assets/queries.rq
